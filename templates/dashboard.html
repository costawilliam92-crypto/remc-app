{% extends "base.html" %}

{% block title %}REMC Dashboard{% endblock %}

{% block content %}
<!-- iOS Install Banner -->
<div id="ios-install-banner" class="d-none">
    <div class="alert alert-success alert-dismissible" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a472a, #2d5a3d); border: none; color: white;">
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">
                <h6 class="mb-1" style="color: #ffd700;"><i class="fas fa-mobile-alt"></i> Install REMC App</h6>
                <small>Add to your home screen for easy access!</small>
            </div>
            <div>
                <button class="btn btn-light btn-sm" onclick="showIOSInstructions()" style="margin-right: 10px;">
                    <i class="fas fa-download"></i> Install
                </button>
                <button type="button" class="btn-close btn-close-white" onclick="hideInstallBanner()"></button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> Dashboard
            <small class="text-muted">Welcome to REMC Project Management</small>
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card text-center">
            <div class="stats-number" id="total-projects">{{ stats.total_projects }}</div>
            <div class="stats-label">Total Projects</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card text-center" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <div class="stats-number" id="active-projects">{{ stats.active_projects }}</div>
            <div class="stats-label">Active Projects</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card text-center" style="background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);">
            <div class="stats-number" id="total-emails">{{ stats.total_emails }}</div>
            <div class="stats-label">Tracked Emails</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card text-center" style="background: linear-gradient(135deg, #fdbb2d 0%, #22c1c3 100%);">
            <div class="stats-number" id="recent-emails">{{ stats.recent_emails }}</div>
            <div class="stats-label">Recent Emails</div>
        </div>
    </div>
</div>

<!-- Quick Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search"></i> Quick Project Search</h5>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <input type="text" 
                           class="form-control search-box" 
                           placeholder="Search projects by name, ID, client, or location..." 
                           id="quick-search"
                           onkeyup="debounce(searchProjects(this.value), 300)">
                    <button class="btn btn-primary" type="button" onclick="performSearch()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <!-- Search Results -->
                <div id="search-results" class="list-group mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Project Overview -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Project Distribution</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary">{{ stats.residential_projects }}</h4>
                            <small class="text-muted">Residential</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-info">{{ stats.commercial_projects }}</h4>
                            <small class="text-muted">Commercial</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="progress" style="height: 20px;">
                        {% set total = stats.residential_projects + stats.commercial_projects %}
                        {% if total > 0 %}
                            <div class="progress-bar bg-primary" 
                                 style="width: {{ (stats.residential_projects / total * 100)|round(1) }}%">
                                Residential {{ (stats.residential_projects / total * 100)|round(1) }}%
                            </div>
                            <div class="progress-bar bg-info" 
                                 style="width: {{ (stats.commercial_projects / total * 100)|round(1) }}%">
                                Commercial {{ (stats.commercial_projects / total * 100)|round(1) }}%
                            </div>
                        {% else %}
                            <div class="progress-bar bg-secondary" style="width: 100%">No Projects</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('projects') }}" class="btn btn-primary">
                        <i class="fas fa-folder-open"></i> View All Projects
                    </a>
                    <a href="{{ url_for('emails') }}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope"></i> Email Tracking
                    </a>
                    <button class="btn btn-outline-secondary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Projects -->
{% if recent_projects %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Projects</h5>
                <a href="{{ url_for('projects') }}" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for project in recent_projects %}
                    <div class="col-lg-6 col-md-12 mb-3">
                        <div class="project-card" onclick="window.location.href='/project/{{ project.id }}'">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1">{{ project.name or project.id }}</h6>
                                <span class="project-type {{ project.type.lower() }}">
                                    {{ project.type }}
                                </span>
                            </div>
                            
                            <p class="mb-1 text-muted">
                                <i class="fas fa-user"></i> {{ project.client or 'No client specified' }}
                            </p>
                            
                            {% if project.location %}
                            <p class="mb-1 text-muted">
                                <i class="fas fa-map-marker-alt"></i> {{ project.location }}
                            </p>
                            {% endif %}
                            
                            {% if project.status %}
                            <p class="mb-0">
                                <span class="badge bg-secondary">{{ project.status }}</span>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mobile-optimized floating action button -->
<div class="d-md-none">
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
        <div class="dropdown dropup">
            <button class="btn btn-primary rounded-circle" 
                    type="button" 
                    data-bs-toggle="dropdown" 
                    style="width: 56px; height: 56px;">
                <i class="fas fa-plus"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('projects') }}">
                    <i class="fas fa-folder-plus"></i> View Projects
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('emails') }}">
                    <i class="fas fa-envelope-plus"></i> Email Tracking
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="showIOSInstructions(); return false;">
                    <i class="fas fa-download"></i> Install App
                </a></li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Dashboard-specific JavaScript
    let searchTimeout;
    
    // Check if iOS and show install banner
    function checkAndShowInstallBanner() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
                                   window.navigator.standalone === true;
        const bannerDismissed = localStorage.getItem('iosInstallBannerDismissed');
        
        if (isIOS && !isInStandaloneMode && !bannerDismissed) {
            document.getElementById('ios-install-banner').classList.remove('d-none');
        }
    }
    
    function showIOSInstructions() {
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📱</div>
                    <h4 style="color: #1a472a; margin-bottom: 20px;">Install REMC App</h4>
                    <p style="margin-bottom: 20px; color: #666; text-align: left;">To install REMC on your iPhone:</p>
                    <ol style="text-align: left; color: #333; margin-bottom: 25px; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">Tap the <strong>Share button</strong> <span style="display: inline-block; padding: 2px 6px; background: #007AFF; color: white; border-radius: 4px; font-size: 12px;">□↗</span> at the bottom of Safari</li>
                        <li style="margin-bottom: 8px;">Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                        <li style="margin-bottom: 8px;">Tap <strong>"Add"</strong> in the top right corner</li>
                        <li style="margin-bottom: 8px;">REMC will appear on your home screen like a native app!</li>
                    </ol>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #1a472a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; width: 100%;">Got it!</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        hideInstallBanner();
    }
    
    function hideInstallBanner() {
        document.getElementById('ios-install-banner').classList.add('d-none');
        localStorage.setItem('iosInstallBannerDismissed', 'true');
    }
    
    function debounce(func, delay) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(func, delay);
    }
    
    function performSearch() {
        const query = document.getElementById('quick-search').value;
        if (query.trim()) {
            window.location.href = `/projects?search=${encodeURIComponent(query)}`;
        }
    }
    
    function refreshDashboard() {
        const button = event.target;
        const icon = button.querySelector('i');
        
        // Add spinning animation
        icon.classList.add('fa-spin');
        button.disabled = true;
        
        // Refresh stats
        refreshStats();
        
        // Stop spinning after 2 seconds
        setTimeout(() => {
            icon.classList.remove('fa-spin');
            button.disabled = false;
        }, 2000);
    }
    
    // Enhanced search with results display
    function searchProjects(query) {
        const resultsContainer = document.getElementById('search-results');
        
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }
        
        fetch(`/api/projects/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data);
                resultsContainer.style.display = data.length > 0 ? 'block' : 'none';
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.style.display = 'none';
            });
    }
    
    function displaySearchResults(projects) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        if (projects.length === 0) {
            resultsContainer.innerHTML = '<div class="list-group-item text-muted">No projects found</div>';
            return;
        }
        
        projects.forEach(project => {
            const projectElement = document.createElement('a');
            projectElement.className = 'list-group-item list-group-item-action';
            projectElement.href = `/project/${project.id}`;
            projectElement.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${project.name || project.id}</h6>
                    <small class="project-type ${project.type.toLowerCase()}">${project.type}</small>
                </div>
                <p class="mb-1">${project.id} - ${project.client || 'No client'}</p>
                <small class="text-muted">${project.status || 'No status'}</small>
            `;
            resultsContainer.appendChild(projectElement);
        });
    }
    
    // Handle Enter key in search box
    document.getElementById('quick-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchBox = document.getElementById('quick-search');
        const resultsContainer = document.getElementById('search-results');
        
        if (!searchBox.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAndShowInstallBanner(); // Show install banner if iOS
    });
</script>
{% endblock %}