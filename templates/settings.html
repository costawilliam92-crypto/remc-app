{% extends "base.html" %}

{% block title %}Settings - REMC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog"></i> Settings
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 col-12">
        <!-- Display Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-desktop"></i> Display Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Default Project View</label>
                        <select class="form-control" id="default-view">
                            <option value="list">List View</option>
                            <option value="grid">Grid View</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Items Per Page</label>
                        <select class="form-control" id="items-per-page">
                            <option value="10">10 items</option>
                            <option value="20" selected>20 items</option>
                            <option value="50">50 items</option>
                            <option value="100">100 items</option>
                        </select>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dark-mode">
                            <label class="form-check-label" for="dark-mode">
                                Dark Mode (Coming Soon)
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                            <label class="form-check-label" for="auto-refresh">
                                Auto-refresh data every 5 minutes
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Notification Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                            <label class="form-check-label" for="email-notifications">
                                Show notifications for new tracked emails
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="project-notifications">
                            <label class="form-check-label" for="project-notifications">
                                Show notifications for project updates
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sound-notifications">
                            <label class="form-check-label" for="sound-notifications">
                                Play sound for notifications
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-database"></i> Data Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Cache Duration</label>
                        <select class="form-control" id="cache-duration">
                            <option value="5">5 minutes</option>
                            <option value="15" selected>15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">1 hour</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Sync Frequency</label>
                        <select class="form-control" id="sync-frequency">
                            <option value="manual">Manual only</option>
                            <option value="5" selected>Every 5 minutes</option>
                            <option value="15">Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="clearCache()">
                                <i class="fas fa-trash"></i> Clear Cache
                            </button>
                            <button class="btn btn-outline-info" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools"></i> Advanced Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="debug-mode">
                            <label class="form-check-label" for="debug-mode">
                                Enable debug mode (for troubleshooting)
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="offline-mode">
                            <label class="form-check-label" for="offline-mode">
                                Enable offline mode (cache data locally)
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label class="form-label">API Endpoint</label>
                        <input type="url" class="form-control" id="api-endpoint" value="/api" readonly>
                        <small class="form-text text-muted">Custom API endpoint (advanced users only)</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Settings -->
        <div class="card">
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-outline-secondary" onclick="resetSettings()">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Information Sidebar -->
    <div class="col-lg-4 col-12">
        <!-- Application Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Application Info</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <i class="fas fa-hard-hat fa-3x text-primary"></i>
                    <h6 class="mt-2">REMC Web App</h6>
                    <p class="text-muted small">Version 1.0.0</p>
                </div>
                
                <div class="small">
                    <p><strong>Platform:</strong> Web-based</p>
                    <p><strong>Compatibility:</strong> iOS, Android, Desktop</p>
                    <p><strong>Last Updated:</strong> <span id="last-updated">Loading...</span></p>
                    <p><strong>Server Status:</strong> <span id="server-status" class="badge bg-success">Online</span></p>
                </div>
            </div>
        </div>
        
        <!-- Storage Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-hdd"></i> Storage Info</h5>
            </div>
            <div class="card-body">
                <div class="small">
                    <p><strong>Cache Size:</strong> <span id="cache-size">Calculating...</span></p>
                    <p><strong>Offline Data:</strong> <span id="offline-data">Disabled</span></p>
                    <p><strong>Browser Storage:</strong> <span id="browser-storage">Available</span></p>
                </div>
                
                <div class="progress mb-2" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" style="width: 25%"></div>
                </div>
                <small class="text-muted">Storage usage: 25% of available space</small>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightning-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="checkForUpdates()">
                        <i class="fas fa-sync-alt"></i> Check for Updates
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="testConnection()">
                        <i class="fas fa-wifi"></i> Test Connection
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="reportBug()">
                        <i class="fas fa-bug"></i> Report Bug
                    </button>
                    <a href="{{ url_for('help_page') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-question-circle"></i> Get Help
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Load settings from localStorage
    function loadSettings() {
        const settings = {
            'default-view': localStorage.getItem('projectView') || 'list',
            'items-per-page': localStorage.getItem('itemsPerPage') || '20',
            'auto-refresh': localStorage.getItem('autoRefresh') !== 'false',
            'email-notifications': localStorage.getItem('emailNotifications') !== 'false',
            'project-notifications': localStorage.getItem('projectNotifications') === 'true',
            'sound-notifications': localStorage.getItem('soundNotifications') === 'true',
            'cache-duration': localStorage.getItem('cacheDuration') || '15',
            'sync-frequency': localStorage.getItem('syncFrequency') || '5',
            'debug-mode': localStorage.getItem('debugMode') === 'true',
            'offline-mode': localStorage.getItem('offlineMode') === 'true'
        };
        
        // Apply settings to form
        Object.entries(settings).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value;
                } else {
                    element.value = value;
                }
            }
        });
    }
    
    function saveSettings() {
        const settings = {
            'projectView': document.getElementById('default-view').value,
            'itemsPerPage': document.getElementById('items-per-page').value,
            'autoRefresh': document.getElementById('auto-refresh').checked,
            'emailNotifications': document.getElementById('email-notifications').checked,
            'projectNotifications': document.getElementById('project-notifications').checked,
            'soundNotifications': document.getElementById('sound-notifications').checked,
            'cacheDuration': document.getElementById('cache-duration').value,
            'syncFrequency': document.getElementById('sync-frequency').value,
            'debugMode': document.getElementById('debug-mode').checked,
            'offlineMode': document.getElementById('offline-mode').checked
        };
        
        // Save to localStorage
        Object.entries(settings).forEach(([key, value]) => {
            localStorage.setItem(key, value);
        });
        
        // Show success message
        showToast('Settings saved successfully!', 'success');
        
        // Apply settings immediately
        applySettings(settings);
    }
    
    function resetSettings() {
        if (confirm('This will reset all settings to default values. Continue?')) {
            // Clear localStorage
            const keys = ['projectView', 'itemsPerPage', 'autoRefresh', 'emailNotifications', 
                         'projectNotifications', 'soundNotifications', 'cacheDuration', 
                         'syncFrequency', 'debugMode', 'offlineMode'];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            // Reload settings
            loadSettings();
            
            showToast('Settings reset to defaults', 'info');
        }
    }
    
    function applySettings(settings) {
        // Apply auto-refresh setting
        if (settings.autoRefresh) {
            console.log('Auto-refresh enabled');
        } else {
            console.log('Auto-refresh disabled');
        }
        
        // Apply debug mode
        if (settings.debugMode) {
            console.log('Debug mode enabled');
            window.debugMode = true;
        } else {
            window.debugMode = false;
        }
    }
    
    function clearCache() {
        if (confirm('This will clear all cached data. Continue?')) {
            // Clear various caches
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            
            // Clear localStorage (except settings)
            const settingsKeys = ['projectView', 'itemsPerPage', 'autoRefresh'];
            const toPreserve = {};
            settingsKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    toPreserve[key] = localStorage.getItem(key);
                }
            });
            
            localStorage.clear();
            
            Object.entries(toPreserve).forEach(([key, value]) => {
                localStorage.setItem(key, value);
            });
            
            showToast('Cache cleared successfully', 'success');
        }
    }
    
    function exportData() {
        // Create a simple data export
        const data = {
            settings: {
                projectView: localStorage.getItem('projectView'),
                itemsPerPage: localStorage.getItem('itemsPerPage'),
                autoRefresh: localStorage.getItem('autoRefresh')
            },
            timestamp: new Date().toISOString(),
            version: '1.0.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'remc-settings.json';
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Settings exported successfully', 'success');
    }
    
    function checkForUpdates() {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        button.disabled = true;
        
        // Simulate update check
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
            showToast('You are running the latest version', 'info');
        }, 2000);
    }
    
    function testConnection() {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;
        
        // Test connection to server
        fetch('/api/stats')
            .then(response => {
                if (response.ok) {
                    showToast('Connection successful', 'success');
                    document.getElementById('server-status').className = 'badge bg-success';
                    document.getElementById('server-status').textContent = 'Online';
                } else {
                    throw new Error('Server error');
                }
            })
            .catch(error => {
                showToast('Connection failed', 'error');
                document.getElementById('server-status').className = 'badge bg-danger';
                document.getElementById('server-status').textContent = 'Offline';
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }
    
    function reportBug() {
        const info = {
            userAgent: navigator.userAgent,
            url: window.location.href,
            timestamp: new Date().toISOString(),
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            settings: {
                projectView: localStorage.getItem('projectView'),
                debugMode: localStorage.getItem('debugMode')
            }
        };
        
        alert('Bug report information:\n\n' + JSON.stringify(info, null, 2) + '\n\nPlease copy this information when reporting bugs.');
    }
    
    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    function updateInfo() {
        // Update last updated time
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
        
        // Calculate cache size (approximate)
        let cacheSize = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                cacheSize += localStorage[key].length;
            }
        }
        document.getElementById('cache-size').textContent = `${(cacheSize / 1024).toFixed(1)} KB`;
        
        // Check browser storage
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            navigator.storage.estimate().then(estimate => {
                const used = estimate.usage || 0;
                const quota = estimate.quota || 0;
                document.getElementById('browser-storage').textContent = 
                    `${(used / 1024 / 1024).toFixed(1)} MB / ${(quota / 1024 / 1024).toFixed(1)} MB`;
            });
        }
    }
    
    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        updateInfo();
        
        // Update info every 30 seconds
        setInterval(updateInfo, 30000);
    });
</script>
{% endblock %}